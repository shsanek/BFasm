# BFASM

<img src="https://github.com/user-attachments/assets/a4c9a7e7-d7ab-4ee1-878a-05be4c025ab0" alt="INITIAL" width="200"/>

Это проект для генерации кода Brainfuck, который выполняет ассемблер BFASM на виртуальной машине с 16-битной оперативной памятью. Виртуальная машина работает с ячейками размером 2 байта (16 бит). Доступно 2^16 ячеек или 128 КБ памяти для адресации. Машина имеет 6 регистров общего назначения (r0-r5), команды работы со стеком, команды условного перехода и базовые команды 16-битной целочисленной арифметики. Проект носит развлекательный и образовательный характер.

## BF Code

[BF Code](Sources/Products/result.bf) - это код системного ядра вместе с парсером `BFasm`

## Проверенные интерпретаторы

Не все интерпретаторы способны выполнять ядро с нормальной скоростью. У других могут быть проблемы с консольным вводом/выводом, что делает вставку больших программ проблемой.

1. [nayuki.io](https://www.nayuki.io/page/brainfuck-interpreter-javascript) - работает хорошо
2. [brainfuck.michd.me](https://brainfuck.michd.me/) - требуется некоторая работа для ввода, не работает копирование/вставка для ввода
3. [mitxela](https://mitxela.com/other/brainfuck) - не работает копирование/вставка для ввода
4. [bf.doleczek.pl/](https://www.bf.doleczek.pl/) - не работает копирование/вставка для ввода

## Примерные программы

Встроенный ассемблер не поддерживает метки. Для удобства я связываю примеры с использованием `AsmBuilder`

1. [Решето Эратосфена](Sources/AsmBuilder/example/SieveOfEratosthenes.bfasm) - после `run` необходимо предоставить последнее число для проверки в качестве ввода
2. [Интерпретатор BF](Sources/AsmBuilder/example/bfemu.bfasm) - после `run` следует программа на brainfuck с `;`, затем данные для ввода. Я тестировал эту программу не очень тщательно, поэтому она может не работать корректно в некоторых случаях.

## Описание команд виртуальной машины

| Команда  | Описание                                                                                  |
|----------|---------------------------------------------------------------------------------------------|
| `mov`    | Перемещение данных из одного места в другое                                                 |
| `add`    | Сложение двух операндов                                                                     |
| `sub`    | Вычитание одного операнда из другого                                                        |
| `mul`    | Умножение двух операндов                                                                    |
| `div`    | Деление одного операнда на другой                                                           |
| `mod`    | Остаток от деления одного операнда на другой                                                |
| `push`   | Помещение значения в стек                                                                   |
| `pop`    | Извлечение значения из стека                                                                |
| `cmp`    | Сравнение двух операндов                                                                    |
| `jmp`    | Переход к указанной команде                                                                 |
| `jz`     | Переход к указанной команде, если результат сравнения равен нулю                            |
| `jnz`    | Переход к указанной команде, если результат сравнения не равен нулю                         |
| `run`    | Начинает выполнение кода выше. Точка с запятой после этой команды не нужна.                 |

### Память

Каждая команда занимает 1 или 2 ячейки памяти (2, если есть константа). Программа будет загружена с ячейки 0. Регистр `cs` укажет на ячейку, следующую за программой.

## Стек памяти

Этот стек находится в памяти и управляется с помощью `push` и `pop`. Стек растет вверх и расположен непосредственно после загруженной программы. Вы можете получить доступ к удаленным значениям стека, используя регистр `cs` (после копирования его в регистр общего назначения) или используя `get`. `cs` - это указатель на голову с последним значением.

## Структура команды

Команда может иметь от 0 до 2 аргументов. Первый аргумент может быть изменен в зависимости от команды. Второй аргумент является операндом и не изменяется.

### Аргументы

Аргументы могут быть:

- **Регистры**: `r0`, `r1`, `r2`, `r3`, `r4`, `r5`
- **Указатели на память** (только через регистры): `ptr r0`, `ptr r1`, `ptr r2`, `ptr r3`, `ptr r4`, `ptr r5`
- **Константы**: Десятичное число, например, `12345` увеличивает занимаемое командой пространство памяти на 1. (только одна на команду)
- **Специальные значения**:
  - `cs` - Указатель на память в текущем значении стека
  - `s0` - Верхнее значение быстрого стека

### Синтаксис команды

Каждая команда должна заканчиваться точкой с запятой `;`, включая комментарии, но после команды `run` точка с запятой не нужна.

### Пример команды

```asm
sub r0, r1;
```
### Быстрый стек
Быстрый стек - это основной стек (не в памяти), содержащий только 8 значений по 16 бит. При переполнении этого стека значения безвозвратно теряются. Некоторые команды могут сохранять дополнительные данные в этот стек, такие как mul и div.

#### Операции быстрого стека
Для операций pop/push с быстрым стеком используйте s0. Если s0 используется для чтения, происходит pop; если для записи, происходит push.

Примеры операций быстрого стека
Команда `mov s0, 12;` выполняет push.
Команда `mov r0, s0;` выполняет pop.
Команда `sub s0, r1;` сначала выполняет pop, затем pu
